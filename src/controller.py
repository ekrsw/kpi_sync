from concurrent.futures import ThreadPoolExecutor, as_completed
import logging
import threading

from src.excel_sync import SynchronizedExcelProcessor
from src.scraper import Scraper
import settings


logger = logging.getLogger(__name__)

def sync_process_controller():
    stop_event = threading.Event()

    excel_processor = SynchronizedExcelProcessor(
        file_paths=settings.EXCEL_FILES,
        max_retries=settings.SYNC_MAX_RETRIES,
        retry_delay=settings.SYNC_RETRY_DELAY,
        refresh_interval=settings.REFRESH_INTERVAL
    )

    # scraper処理をここに書く
    scraper = Scraper()


    with ThreadPoolExecutor(max_workers=5) as executor:
        futures = []

        # Excelファイルの処理をタスクとして追加
        logger.debug("Excelファイルの処理をタスクとして追加しています。")
        for file_path in excel_processor.file_paths:
            futures.append(
                executor.submit(excel_processor.process_file, file_path, stop_event)
            )
        
        # scraping処理をタスクとして追加
        logger.debug("スクレイピングの処理をタスクとして追加しています。")
        futures.append(
            executor.submit(scraper.test, settings.TEMPLATE_TVS, stop_event)
        )

        try:
            for future in as_completed(futures):
                result = future.result()
        except KeyboardInterrupt:
            logger.info("停止信号を受け取りました。全てのタスクを停止します。")
            stop_event.set()
        
        except Exception as e:
            logger.error(f"エラーが発生しました。: {e}")
            stop_event.set()
        
